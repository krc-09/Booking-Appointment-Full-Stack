<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox - Realtime Chatting App with Socket.io</title>
    <link rel="stylesheet" href="../main/chat.css">
</head>

<body>
    <nav>
        <img class="logo" src="logo.png" alt="">
        <h1>Chatting Application</h1>
    </nav>

    <!-- Container for Messages -->
    <div class="container" id="msg-container">
        <ul id="messageList"></ul>
    </div>

    <!-- Form to Send Messages -->
    <div class="send">
        <form onsubmit="handleFormSubmit(event)" id="send-container">
            <input type="text" name="messaging" id="messageInp" placeholder="Type a message..." required>
            <button class="btn" type="submit">Send</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Function to parse JWT and get the user information
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
    
            return JSON.parse(jsonPayload);
        }
    
        const token = localStorage.getItem('token');
        const currentUser = parseJwt(token); // Get current user info from the JWT
    
        let displayedMessages = new Set(); // Track displayed messages using their unique IDs or timestamps
    
        // Save a message to localStorage (max 10 messages)
        function saveMessageToLocalStorage(message) {
            let messages = JSON.parse(localStorage.getItem('messages')) || [];

            // Check if the message already exists based on its unique key
            const messageKey = `${message.username}-${message.createdAt}`;
            if (!messages.some(existingMessage => `${existingMessage.username}-${existingMessage.createdAt}` === messageKey)) {
                messages.push(message);
                if (messages.length > 10) {
                    messages.shift(); // Remove the oldest message
                }
                localStorage.setItem('messages', JSON.stringify(messages));
            }
        }
    
        // Display messages from localStorage
        function displayMessagesFromLocalStorage() {
            const messages = JSON.parse(localStorage.getItem('messages')) || [];
            const messageList = document.getElementById("messageList");
            messageList.innerHTML = ''; // Clear the list first

            messages.forEach(message => {
                // Check if this message is already displayed based on its unique key
                const messageKey = `${message.username}-${message.createdAt}`;
                if (!displayedMessages.has(messageKey)) {
                    const li = document.createElement('li');
                    li.textContent = `${message.username}: ${message.messagecontent}`;
                    messageList.appendChild(li);
                    displayedMessages.add(messageKey); // Track this message
                }
            });
        }
    
        // Handle form submission for sending messages
        function handleFormSubmit(event) {
            event.preventDefault();
    
            const messageDetails = {
                messagecontent: event.target.messaging.value
            };
    
            axios.post("http://localhost:3000/messages/add-messages", messageDetails, { headers: { "Authorization": token } })
                .then(response => {
                    const messageData = response.data;
                    saveMessageToLocalStorage(messageData); // Save message to localStorage
                    displayedMessages.add(`${messageData.username}-${messageData.createdAt}`); // Track it to prevent duplication
                    document.getElementById("messageInp").value = ""; // Clear input field
                })
                .catch(error => console.error(error));
        }
    
        // Append a message to the message list
        function appendMessage(message) {
            const messageList = document.getElementById("messageList");
            const li = document.createElement('li');
    
            if (message.username === currentUser.name) {
                li.textContent = `YOU: ${message.messagecontent}`;
            } else {
                li.textContent = `${message.username}: ${message.messagecontent}`;
            }
    
            messageList.appendChild(li);
        }
    
        // Display the list of messages
        async function displaymessages() {
            try {
                const response = await axios.get('http://localhost:3000/messages/get-messages', {
                    headers: { "Authorization": token },
                });
    
                const messages = response.data.messages;

                // Iterate through the messages to display them
                messages.forEach(message => {
                    // Check if this message has been displayed using unique identifiers
                    const messageKey = `${message.username}-${message.createdAt}`;

                    if (!displayedMessages.has(messageKey)) {
                        appendMessage(message); // Append message if not already displayed
                        saveMessageToLocalStorage(message); // Save it to localStorage
                        displayedMessages.add(messageKey); // Track it to prevent duplication
                    }
                });
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }
    
        // Display logged-in users
        function displayLoggedInUsers() {
            axios.get("http://localhost:3000/users/loggedin", { headers: { "Authorization": token } })
                .then(response => {
                    const userList = document.getElementById('msg-container');
                    response.data.forEach(user => {
                        const userElement = document.createElement('p');
                        if (user.name === currentUser.name) {
                            userElement.textContent = `You joined`;
                        } else {
                            userElement.textContent = `${user.name} joined`;
                        }
                        userList.appendChild(userElement);
                    });
                })
                .catch(error => console.error('Error fetching logged-in users:', error));
        }
    
        // On page load
        window.onload = function () {
            displayMessagesFromLocalStorage(); // Display messages from localStorage
            displayLoggedInUsers(); // Display currently logged-in users
            displaymessages(); // Display new messages from the server
            setInterval(displaymessages, 2000); // Periodically fetch new messages every 2 seconds
        };
    </script>
    
</body>

</html>


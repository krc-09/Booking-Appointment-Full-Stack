<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox-Realtime chatting app with socket io</title>
   
    <link rel="stylesheet" href="../main/chat.css">
</head>
<body>
    <nav ><img class="logo" src="logo.png" alt=""><h1> Chatting APPLICATION</h1></nav>
    <div class="container" id = "msg-container">
  <ul></ul>
</div>
<div class="send"><form onsubmit = "handleFormSubmit(event)"id="send-container">
    <input type="text"name="messaging"id="messageInp">
    <button class="btn"type="submit">Send</button>
</form>

</div>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }
const token = localStorage.getItem('token'); 
const currentUser = parseJwt(token);



let currentmessageId = null;

        function handleFormSubmit(event) {
            event.preventDefault();

            const messageDetails = {
               messagecontent: event.target.messaging.value,
              
            };
            const token = localStorage.getItem('token'); 

            axios.post("http://localhost:3000/messages/add-messages", messageDetails, { headers: { "Authorization": token } })
                .then((response) => {
                    const messagelist = document.querySelector("ul");
                    const li = document.createElement('li');
                    if (response.data.username === currentUser.name) {
                li.textContent = `YOU: ${response.data.messagecontent}`;
            } else {
                li.textContent = `${response.data.username}: ${response.data.messagecontent}`;
            }
                    
                })
                .catch((error) => console.log(error));

          
            document.getElementById("messageInp").value = "";
           
        }

window.onload = function () {
    axios.get("http://localhost:3000/users/loggedin", { headers: { "Authorization": token } })
        .then(response => {
            const userList = document.getElementById('msg-container');
          

            response.data.forEach(user => {
                const userElement = document.createElement('p');

                // Check if the user is the current user by comparing the name
                if (user.name === currentUser.name) {
                    userElement.textContent = `You joined`;
                } else {
                    userElement.textContent = `${user.name} joined`;
                }

                userList.appendChild(userElement);
            });
        })
        .catch(error => {
            console.error('Error fetching logged-in users:', error);
        });
        displaymessages();
};

async function displaymessages() {
    try {
        const token = localStorage.getItem('token');
        const response = await axios.get('http://localhost:3000/messages/get-messages', {
            headers: { "Authorization": token }
        });

        const messages = response.data.messages; // Get messages from the response
        const username = response.data.username; // Get username from the response
        const messageList = document.querySelector("ul");

        messageList.innerHTML = '';

        messages.forEach(message => {
            const li = document.createElement('li');
            if (message.username === currentUser.name) {
                li.textContent = `YOU: ${message.messagecontent}`;
            } else {
                li.textContent = `${message.username}: ${message.messagecontent}`;
            }
            messageList.appendChild(li);
        });

    } catch (error) {
        console.error('Error fetching messages:', error);
    }
}


</script>

